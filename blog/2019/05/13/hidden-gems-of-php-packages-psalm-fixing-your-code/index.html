<!DOCTYPE html>
<html lang="en">
    <head>
    <title>Hidden Gems of PHP Packages: Psalm Fixing Your Code | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css" rel="stylesheet" type="text/css" />

    <link href="/assets/gifplayer/gifplayer.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/checklist.css" rel="stylesheet" type="text/css" />
</head>
    <body>
                <!-- post_id: 211 -->

        
<div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="me_avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li class="">
                    <a href="/php-framework-trends">Trends</a>
                </li>
                <li class="">
                    <a href="/clusters">Clusters</a>
                </li>
                <li class="">
                    <a href="/mission">Mission</a>
                </li>
                <li class="">
                    <a href="/talks">Talks</a>
                </li>
                <li class="">
                    <a href="/contact">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                Blog
            </a>


            <a href="/clusters" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>

            <a href="/php-framework-trends" class="col-3 col-sm-3 ">
                <em class="fas fa-chart-bar"></em>
                <br>
                Trends
            </a>

            <a href="/contact" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center" id="top-menu-search-mobile">
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="tomasvotruba.com" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
</form>
    </div>
</div>

        <div class="mainContent">
            <div class="container-fluid" id="post">
                <div class="text-center">
    <a href="https://github.com/sponsors/TomasVotruba" class="btn btn-outline-light d-block mt-3 btn-outline-dark" id="support-me-button">
        Do you find <strong>these posts helpful</strong>?
        <div class="hidden-md-up"><br></div>
        &nbsp;❤️ &nbsp;Support me on GitHub Sponsors&nbsp; <em class="fab fa-github fa-fw"></em>
    </a>
</div>

                <h1>Hidden Gems of PHP Packages: Psalm Fixing Your Code</h1>

                <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-clock fa-fw"></em>
        <strong>3 min</strong>
    </li>

    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2019-05-Mon">
            <strike>
                            Mon, May 13, 2019
            
            </strike>        </time>
    </li>

            <li class="list-inline-item mr-3 text-success">
            <em class="fas fa-fw fa-sync"></em> Updated Jun, 2019
        </li>
    
            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="/blog/2019/05/13/hidden-gems-of-php-packages-psalm-fixing-your-code/#disqus_thread">X</a> comments
        </li>
    
    
            <li class="list-inline-item mr-3 text-primary">
            <em class="fab fa-fw fa-github"></em>
            <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/master/packages/blog/config/data/2019/2019-05-13-hidden-gems-of-php-packages-psalm-fixing-your-code.md">Edit Post</a>
        </li>
    </ul>

                
                                    <div class="card border-success card-bigger">
                        <div class="card-header text-white bg-success">
                            <strong>This post was updated at June 2019</strong>
                        </div>
                        <div class="card-body">
                            <p>A new option <code>--issues=all</code> is added in Psalm 3.3.1</p>
                        </div>
                    </div>

                    <br>
                
                <div class="card card-bigger">
                    <div class="card-body">
                        <p>Psalm is a static analyzer of PHP code originated at Vimeo and developed by <a href="http://github.com/muglug">Muglug</a>. It can analyze your code for incorrect type declarations or unused code.
<br><br>
But did you know it can automatically fix these issues?</p>
                    </div>
                </div>

                <p>I did not and I was surprised. Psalm added this feature long time ago in March 2018 (as <a href="https://www.reddit.com/r/PHP/comments/84xrgy/fixing_code_that_aint_broken_vimeo_engineering/">reported on Reddit</a>)! I was also surprised because static analyzer is read-only tools - &quot;here is error → fix it yourself manually&quot;</p>
<h2>Static Analyzers Evolving to Code Fixers</h2>
<p><strong>But it's not an unexpected development.</strong> As I wrote in <em><a href="/blog/2018/10/22/brief-history-of-tools-watching-and-changing-your-php-code/">Brief History of Tools Watching and Changing Your PHP Code</a></em>, coding standard tools were <em>read-only</em> too and you had to change all the spaces manually. That was so annoying with large code-bases and many programmers didn't adopt it because it added the extra work on a daily basis, instead of saving time.</p>
<p>In response to this pressure, they <strong>had to become more useful by working for the programmer</strong>. PHP CS Fixer fixed code from the very first commit and PHP_CodeSniffer added this feature in response.</p>
<p>We can assume PHPStan and Phan will follow Psalm path since human-fixing is hard to scale and will become annoying in time compared to automated instant upgrades.</p>
<p><br></p>
<p>So what Psalm can do for you?</p>
<h2>1. Missing Type Declaration?</h2>
<p>Do you know that feeling when PHPStan reports &quot;Method X is returning an int, but should be a string&quot; in 10 000 places? Yes, you can use <a href="/blog/2019/04/22/hidden-gems-of-php-packages-srab/">Baseliner</a> to ignore them and check only new code, <strong>but that only postpones the problem</strong>. One day there still will be 3-4 days of full-time boring work ahead of you.</p>
<pre><code class="language-php">/**
 * @return int
 */
function foo()
{
  return 'hello';
}</code></pre>
<p>That's what Psalm fixes for you and even adds the return type declaration:</p>
<pre><code class="language-diff">-/**
- * @return int
- */
-function foo()
+function foo(): string
 {
   return 'hello';
 }</code></pre>
<h3>How to Run it?</h3>
<p>Just use binary with <code>--alter</code> (that says &quot;fix&quot; this) + the <code>--issues</code> option:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=MissingReturnType
vendor/bin/psalm src --alter --issues=MissingClosureReturnType
vendor/bin/psalm src --alter --issues=InvalidReturnType
vendor/bin/psalm src --alter --issues=InvalidNullableReturnType</code></pre>
<p>The docs doesn't say if they stack together, but I'd assume so by the plural in &quot;issues&quot;:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=MissingReturnType,MissingClosureReturnType,InvalidReturnType,InvalidNullableReturnType</code></pre>
<h2>2. Falseable Strings?</h2>
<p>Though the same kind of <em>detect type → complete it</em> logic, this example is really nice:</p>
<pre><code class="language-php">function foo(): string {
  return rand(0, 1) ? 'hello' : false;
}</code></pre>
<p>↓</p>
<pre><code>/**
 * @return string|false
 */
function foo() {
  return rand(0, 1) ? 'hello' : false;
}</code></pre>
<h2>3. Unused Property or Method?</h2>
<p>I wish this would be run before each code-review. Imagine you decouple a method during refactoring and stop using one of the existing methods in the same class. A dead method is born. <strong>A dead method that you need to maintain, test and upgrade to new version of PHP or your framework.</strong></p>
<p>Not anymore.</p>
<pre><code class="language-diff"> class A {
-     private function foo() : void {}
-     protected function bar() : void {}
-     public function baz() : void {}
 }

 new A();</code></pre>
<p>Same goes for properties:</p>
<pre><code class="language-diff"> class A {
-    /** @var string */
-    public $foo;

-    /** @var string */
-    protected $bar;
 }

 new A();</code></pre>
<h3>How to Run it?</h3>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=UnusedMethod
vendor/bin/psalm src --alter --issues=PossiblyUnusedMethod
vendor/bin/psalm src --alter --issues=UnusedProperty
vendor/bin/psalm src --alter --issues=PossiblyUnusedProperty</code></pre>
<h2>4. Undefined Variable?</h2>
<p>How do you like this code?</p>
<pre><code class="language-php">if (rand(0, 1)) {
  $a = 5;
}
echo $a;</code></pre>
<p>Ups, <code>$a</code> is not defined (sometimes).</p>
<p>PHPStorm would tell you what's wrong with this code if you'd be writing this code. But again, it adds you extra manual work and doesn't <del>check</del> fix the rest of your huge code base from your CI.</p>
<p>Psalm can:</p>
<pre><code class="language-diff">+$a = null;
 if (rand(0, 1)) {
   $a = 5;
 }
 echo $a;</code></pre>
<p>If you're into static analysis, you know it's very hard to examine this flow of control and moreover add the variable not just the beginning of file or method, but to the right place where you or I would add it.</p>
<p>Cudos to <a href="https://github.com/muglug">Mathew</a>! 👍</p>
<h3>How to Run it?</h3>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=PossiblyUndefinedVariable</code></pre>
<h2>Check all 13 of them</h2>
<p>At the time of writing this post, there is 13 issue alters now. I believe we can expect up to 100 more in next year or two.</p>
<p>You can run them all like this:</p>
<pre><code class="language-bash">vendor/bin/psalm src --alter --issues=all</code></pre>
<p><strong>Read about them and about extra options like <code>--php-version</code>, <code>--dry-run</code> or <code>--safe-types</code> in <a href="https://psalm.dev/docs/fixing_code/">very beautiful and short documentation</a></strong>.</p>
<h2>Try it, Even if you use PHPStan</h2>
<p>Personally, I use PHPStan because I'm not good with XML. But even if I should <strong>install Psalm just to complete type-declarations and remove dead code</strong>, it's worth the 10 minutes time to set it up. Give a try, it's huge time saver the bigger code base you have.</p>
<p>You don't have to take my word for it:</p>
<blockquote class="twitter-tweet mt-5 mb-5" data-lang="en"><p lang="en" dir="ltr">Damn, <a href="https://twitter.com/psalmphp?ref_src=twsrc%5Etfw">@psalmphp</a> type declarations are saving me *TONS* of time and testing.</p>— null (@Ocramius) <a href="https://twitter.com/Ocramius/status/1120797947921350656?ref_src=twsrc%5Etfw">April 23, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p><br></p>
<p>This is the future = PHP tools working for us - enjoy it :)</p>
<p><br><br></p>
<p>Happy coding!</p>

                <br>

                <div class="row mb-5 mt-5">
                    <div class="col-12 mb-5">
                                                                            <a href="/blog/2019/05/09/is-rector-saving-you-time-support-it-on-patreon" class="d-block pt-4 pb-4 pl-4 pr-4 btn btn-success btn-wrappable">
                                <em class="fas fa-fw fa-forward"></em>
                                <strong>Read Next</strong>
                                <br>
                                <span class="text-bigger">
                                    Is Rector Saving you Time? Support it on Patreon!
                                </span>
                            </a>
                                            </div>

                    <div class="col-12">
                        <a href="https://github.com/tomasvotruba/tomasvotruba.com/edit/master/packages/blog/config/data/2019/2019-05-13-hidden-gems-of-php-packages-psalm-fixing-your-code.md" class="d-block btn btn-dark btn-wrappable">
                            <em class="fab fa-fw fa-github"></em>
                            <strong>Found a typo?</strong> Fix it and join team of 90&nbsp;contributors
                        </a>
                    </div>
                </div>

                <br>

                <a name="comments"></a>
                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + 'itsworthsharing' + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>
        </div>

        <script src="/assets/js/jquery-3.3.1.slim.min.js?=988237679"></script>
<script src="/assets/gifplayer/jquery.gifplayer.js?=1050004998"></script>
<script src="/assets/js/cluster-checklist.js?=798284760"></script>
<script src="/assets/js/cluster-expanable.js?=158998304"></script>

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

<script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    $('.gifplayer').gifplayer();

    // sortable table
    $('.sortable_table').DataTable({
        // see https://datatables.net/examples/basic_init/filter_only.html
        "searching": false,
        "paging": false,
        "info": false,
        "order": [[1, "desc"]],
        // see https://datatables.net/examples/advanced_init/sort_direction_control.html
        "aoColumns": [
            null,
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] },
            { "orderSequence": [ "desc", "asc" ] }
        ]
    });
</script>

<div class="text-center mt-5" id="footer">
    <div class="row">
        <div class="col-12">
            Join 22 912 PHP developers every month: <a href="/rss.xml">RSS</a>&nbsp;or&nbsp;<a href="https://twitter.com/votrubaT">@votrubaT</a>
        </div>
    </div>

    <p>
        Build by <a href="/thank-you">90 people</a>

        <span class="pl-2 pr-2">•</span>

        <a href="https://github.com/sponsors/TomasVotruba">Support me</a>

        <span class="hidden-sm-down">
            <span class="pl-2 pr-2">•</span>
            Hosted with <a href="https://www.statie.org/">Statie</a> on <a href="https://github.com/tomasvotruba/tomasvotruba.com">GitHub</a>
        </span>
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="Hidden Gems of PHP Packages: Psalm Fixing Your Code" />
    <meta property="og:description" content="Psalm is a static analyzer of PHP code originated at Vimeo and developed by [Muglug](http://github.com/muglug). It can analyze your code for incorrect type declarations or unused code.

But did you know it can automatically fix these issues?
" />
    <meta property="og:url" content="/blog/2019/05/13/hidden-gems-of-php-packages-psalm-fixing-your-code" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="Hidden Gems of PHP Packages: Psalm Fixing Your Code" />
    <meta name="twitter:description" content="Psalm is a static analyzer of PHP code originated at Vimeo and developed by [Muglug](http://github.com/muglug). It can analyze your code for incorrect type declarations or unused code.

But did you know it can automatically fix these issues?
" />
